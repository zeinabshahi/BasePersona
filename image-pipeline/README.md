# Image Pipeline for Anime‑Cyberpunk Personas

This directory contains a standalone Node/TypeScript pipeline for generating NFT images and metadata based on on‑chain wallet activity.  It implements the **Anime‑Cyberpunk** style described in the project requirements and supports deterministic trait selection, prompt generation, image rendering, post‑processing, and metadata output.

## Overview

The pipeline consists of the following steps:

1. **Trait selection** – Given a wallet record containing metrics such as transaction count, unique contract count, volume in ETH, token diversity, and NFT holdings, the code deterministically assigns each of the eight visible layers (body, aura, headwear, eyes, clothing, accessory, emblem, signature) to a trait bucket.  These buckets mirror the tiers and ranges defined by the project spec.
2. **Prompt assembly** – Using a configurable `prompt_template` and the prompts attached to each trait, the pipeline builds a single text prompt for image generation.  In the Anime‑Cyberpunk style, all images are waist‑up portraits with vibrant colours, cel‑shaded line art and neon accents.
3. **Subject rendering** – The assembled prompt is sent to a Stable Diffusion API endpoint (or another compatible generator) to produce a subject image.  The default behaviour assumes a transparent or chroma‑keyed background so that backgrounds can be composited later.  To configure the API endpoint, set `GEN_API_URL` and optionally `GEN_API_KEY` in a `.env` file.
4. **Post‑processing** – Once a subject image has been generated, it is composited onto one of three pre‑rendered backgrounds (simple blue, builder grid, dual core) based on whether the wallet holds zero, one, or both of the project NFTs.  A branded logo is also placed in the top right corner.  The result is a final PNG ready for minting.
5. **Metadata generation** – For each wallet record the script writes a corresponding JSON metadata file containing the trait names and image filename.  These files can be used in your minting process.

## Directory layout

```
image-pipeline/
├── README.md             # This file
├── package.json          # Local dependencies for the pipeline
├── tsconfig.json         # TypeScript configuration
├── .env.example          # Environment variables example
├── config/
│   └── anime-cyberpunk.json   # Trait definitions and prompt template
├── assets/
│   ├── bg/
│   │   ├── simple-blue.png
│   │   ├── builder-grid.png
│   │   └── dual-core.png
│   └── logo.png
└── src/
    ├── types.ts
    ├── rules.ts
    ├── traits.ts
    ├── prompt.ts
    ├── render.ts
    ├── composite.ts
    └── index.ts
```

## Installing dependencies

Run the following commands inside the `image-pipeline` directory to install dependencies:

```bash
cd image-pipeline
npm install
```

The pipeline depends on `axios` for HTTP requests, `sharp` for image manipulation, `dotenv` for configuration and `commander` for CLI argument parsing.

## Usage

To generate images and metadata for a set of wallet records, run the following from the root of this directory:

```bash
npm run build   # transpile TypeScript to JavaScript
npm start -- -i path/to/wallets.json -n 100
```

The `wallets.json` file should be an array of objects with the following shape:

```json
[
  {
    "address": "0x123...",
    "wallet_birth_month": 1,
    "wallet_age_days": 1000,
    "unique_contracts": 700,
    "active_days": 300,
    "total_txs": 1800,
    "distinct_tokens": 150,
    "volume_eth": 8.2,
    "holds_base_introduced": true,
    "holds_base_builder": true
  },
  ...
]
```

Each run will produce three outputs:

* `output/subjects/` – the raw subject images generated by your API (transparent or chroma‑keyed)
* `output/finals/` – the final composited images with background and logo
* `output/metadata/` – JSON metadata files ready for your NFT minting process

Adjust the API endpoint and image size by editing the `.env` file before running.
